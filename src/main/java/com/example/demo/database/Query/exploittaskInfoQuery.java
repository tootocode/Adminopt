package com.example.demo.database.Query;

import com.example.demo.entity.deviceInfo;
import com.example.demo.entity.exploittaskInfo;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

public class exploittaskInfoQuery extends AbstractQuery{
    public exploittaskInfoQuery(Connection connection) throws SQLException {
        super(connection);
    }
    public List<exploittaskInfo> queryRecord(String sql){
        List<exploittaskInfo> list=new ArrayList<>();
        synchronized (this.connection){
            try{
                ResultSet resultSet = connection.createStatement().executeQuery(sql);
                while(resultSet.next()){
                    exploittaskInfo exploittaskInfo=new exploittaskInfo();
                    exploittaskInfo.setDes(resultSet.getString("taskdesc"));
                    exploittaskInfo.setPostdate(resultSet.getString("taskdate"));
                    exploittaskInfo.setTarget(resultSet.getString("IP"));
                    exploittaskInfo.setModel(resultSet.getString("exploitmodule"));
                    exploittaskInfo.setTaskname(resultSet.getString("taskname"));
                    exploittaskInfo.setRaw(resultSet.getString("exploitresult"));
                    exploittaskInfo.setObject(resultSet.getString("exploitobject"));

                    if(exploittaskInfo.getModel().contains("exploit")){

                        if (exploittaskInfo.getRaw().contains("Unknown answer")){
                            //exploittaskInfo.setExplain("渗透失败,不能识别响应");
                            exploittaskInfo.setExplain("");
                        }
                        else if (exploittaskInfo.getRaw().contains("timed out")){
                            //exploittaskInfo.setExplain("渗透失败,连接超时");
                            exploittaskInfo.setExplain("");
                        }

                        else if (exploittaskInfo.getModel().contains("admin/scada/modicon_password_recovery")||
                                exploittaskInfo.getModel().contains("scanner/http/http_login")||
                                exploittaskInfo.getModel().contains("scanner/ftp/ftp_login")||
                                exploittaskInfo.getModel().contains("scanner/telnet/telnet_ruggedcom")||
                                exploittaskInfo.getModel().contains("scanner/telnet/telnet_login")||
                                exploittaskInfo.getModel().contains("scanner/ssh/ssh_login")){
                                exploittaskInfo.setExplain("弱口令漏洞");
                        }

                        else if (exploittaskInfo.getModel().contains("auxiliary/dos/scada/siemens_siprotec4")||
                                exploittaskInfo.getModel().contains("dos/http/metasploit_httphandler_dos")||
                                exploittaskInfo.getModel().contains("dos/http/slowloris:")||
                                exploittaskInfo.getModel().contains("fuzzers/ssh/ssh_kexinit_corrupt")||
                                exploittaskInfo.getModel().contains("fuzzers/ssh/ssh_version_corrupt")||
                                exploittaskInfo.getModel().contains("fuzzers/ssh/ssh_version_15")||
                                exploittaskInfo.getModel().contains("fuzzers/ssh/ssh_version_2")){
                            exploittaskInfo.setExplain("拒绝服务漏洞");
                        }

                        else if (exploittaskInfo.getModel().contains("admin/scada/modicon_command")||
                                exploittaskInfo.getModel().contains("admin/scada/modicon_stux_transfer")||
                                exploittaskInfo.getModel().contains("admin/scada/multi_cip_command")||
                                exploittaskInfo.getModel().contains("scanner/ftp/anonymous")||
                                exploittaskInfo.getModel().contains("multi/ssh/sshexec")){
                            exploittaskInfo.setExplain("无鉴权漏洞");
                        }

                        else if (exploittaskInfo.getModel().contains("windows/scada/factorylink_csservice")||
                                exploittaskInfo.getModel().contains("windows/scada/factorylink_vrn_09")||
                                exploittaskInfo.getModel().contains("windows/scada/codesys_web_server")||
                                exploittaskInfo.getModel().contains("gather/d20pass")||
                                exploittaskInfo.getModel().contains("windows/scada/ge_proficy_cimplicity_gefebt")||
                                exploittaskInfo.getModel().contains("fuzzers/ftp/ftp_pre_post")||
                                exploittaskInfo.getModel().contains("scanner/telnet/telnet_encrypt_overflow")||
                                exploittaskInfo.getModel().contains("linux/telnet/telnet_encrypt_keyid")||
                                exploittaskInfo.getModel().contains("solaris/telnet/ttyprompt")||
                                exploittaskInfo.getModel().contains("scanner/ssh/ssh_enumusers")){
                            exploittaskInfo.setExplain("权限绕过漏洞");
                        }

                        else if (exploittaskInfo.getModel().contains("dos/scada/d20_tftp_overflow")){
                            exploittaskInfo.setExplain("工控设备漏洞");
                        }

                        else if (exploittaskInfo.getModel().contains("windows/scada/codesys_gateway_server_traversal")||
                                exploittaskInfo.getModel().contains("admin/scada/ge_proficy_substitute_traversal")||
                                exploittaskInfo.getModel().contains("dos/http/apache_commons_fileupload_dos")||
                                exploittaskInfo.getModel().contains("scanner/http/http_traversal")||
                                exploittaskInfo.getModel().contains("scanner/http/httpdasm_directory_traversal")||
                                exploittaskInfo.getModel().contains("scanner/http/simple_webserver_traversal")||
                                exploittaskInfo.getModel().contains("scanner/http/backup_file")||
                                exploittaskInfo.getModel().contains("scanner/http/copy_of_file")||
                                exploittaskInfo.getModel().contains("scanner/http/file_dir")||
                                exploittaskInfo.getModel().contains("multi/http/sit_file_upload")){
                            exploittaskInfo.setExplain("Web服务漏洞");
                        }

                        else if (exploittaskInfo.getModel().contains("scanner/scada/modbus_findunitid")){
                            exploittaskInfo.setExplain("设备信息泄露的问题");
                        }
                        else{
                            exploittaskInfo.setExplain("");
                        }

                        list.add(exploittaskInfo);
                    }


                }
            }catch (SQLException e){
                e.printStackTrace();
            }
        }
        return list;
    }
}
